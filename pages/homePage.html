<!DOCTYPE html>
<html lang="en">
<head>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trackify AI</title>
    <style>
        body { font-family: 'Poppins', sans-serif; background: #034732; color: white; text-align: center; margin: 0; padding: 20px; }
        main { max-width: 400px; margin: auto; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 20px; backdrop-filter: blur(10px); }
        .upload-btn { background: #0ACDFF; color: white; padding: 15px; border-radius: 12px; border: none; width: 100%; font-weight: 800; cursor: pointer; margin-top: 20px; }
        .upload-btn:disabled { background: #666; }
        #status-text { margin: 15px 0; font-size: 0.9rem; color: #CBE896; }
        .history-card { background: rgba(0,0,0,0.3); margin-top: 10px; padding: 10px; border-radius: 10px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<main>
    <h2>Trackify AI</h2>
    <div id="status-text">Ready to scan</div>
    
    <input type="file" id="cameraInput" accept="image/*" capture="camera" style="display: none;">
    <button class="upload-btn" id="scanBtn">Take Photo of Meal</button>
    
    <canvas id="compressCanvas" style="display:none;"></canvas>

    <div id="results" style="margin-top:20px;">
        <p>Total Today: <span id="total-kcal">0</span> kcal</p>
    </div>
</main>

<div id="history-list" style="max-width:400px; margin: 20px auto;"></div>

<script>
    const API_KEY = "AIzaSyC-QeGWJWf4b6fwI2lbq0huDJbs9EFrwGk";
    const scanBtn = document.getElementById('scanBtn');
    const cameraInput = document.getElementById('cameraInput');
    const statusText = document.getElementById('status-text');

    scanBtn.onclick = () => cameraInput.click();

    cameraInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        statusText.innerText = "Processing image...";
        scanBtn.disabled = true;

        try {
            // 1. Compress Image (Crucial for mobile)
            const resizedBase64 = await resizeImage(file);
            const imageData = resizedBase64.split(',')[1];

            statusText.innerText = "Analyzing meal with AI...";

            // 2. API Call
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ 
                            text: "Return JSON only: {'name': 'string', 'calories': number, 'protein': number}. If not food, return {'error': 'not_food'}." 
                        }, { 
                            inline_data: { mime_type: "image/jpeg", data: imageData } 
                        }]
                    }]
                })
            });

            const data = await response.json();

            if (data.error) {
                throw new Error(`${data.error.code}: ${data.error.message}`);
            }

            const rawText = data.candidates[0].content.parts[0].text;
            const jsonMatch = rawText.match(/\{.*\}/s);
            const meal = JSON.parse(jsonMatch[0]);

            if (meal.error) {
                statusText.innerText = "No food detected!";
            } else {
                addMealToHistory(meal);
                statusText.innerText = `Added ${meal.name}!`;
            }

        } catch (err) {
            console.error(err);
            statusText.innerText = "Error: " + err.message;
        } finally {
            scanBtn.disabled = false;
        }
    };

    function resizeImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.getElementById('compressCanvas');
                    const MAX_WIDTH = 800;
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7)); // 70% quality
                };
            };
        });
    }

    function addMealToHistory(meal) {
        const history = JSON.parse(localStorage.getItem('meals') || "[]");
        history.unshift(meal);
        localStorage.setItem('meals', JSON.stringify(history));
        render();
    }

    function render() {
        const history = JSON.parse(localStorage.getItem('meals') || "[]");
        const list = document.getElementById('history-list');
        let total = 0;
        list.innerHTML = '';
        history.forEach(m => {
            total += m.calories;
            list.innerHTML += `<div class="history-card"><span>${m.name}</span><span>${m.calories} kcal</span></div>`;
        });
        document.getElementById('total-kcal').innerText = total;
    }

    render();
</script>
</body>
</html>
